---
title: ""
output: 
  pdf_document:
    latex_engine: xelatex
mainfont: Helvetica Light
fontsize: 12pt
geometry: margin=0.5in
fig_height: 4
fig_width: 4

---


```{r, echo=FALSE}
# --------------------------------------
# R preamble
# --------------------------------------

rm(list=ls())
library(xtable)

# --------------------------------------
# function to strip row/colnames from 
# table and output contents only
# for formatting in latex
# --------------------------------------
cleantable <- function(x,digits) {
 print( xtable(x,digits=digits),
        sanitize.text.function=function(y){y},
        floating=FALSE,
        include.rownames=FALSE,
        include.colnames=FALSE,
        only.contents=TRUE,
        hline.after=NULL
 )
}


# --------------------------------------
# clean table output, including rownames
# --------------------------------------
rowtable <- function(x,digits) {
 print( xtable(x,digits=digits),
        sanitize.text.function=function(y){y},
        floating=FALSE,
        include.rownames=TRUE,
        include.colnames=FALSE,
        only.contents=TRUE,
        hline.after=NULL
 )
}
```



```{r,echo=FALSE}

# --------------------------------------
# Load the water quality dataset to
# get the mid-points of the Entero
# concentrations by each quintile
# --------------------------------------
wq <- read.csv("~/dropbox/13beaches/data/final/13beaches-wq.csv")

minQs <- tapply(wq$avgdyentero1600,wq$qavgdyentero1600,function(x) min(x,na.rm=T))
maxQs <- tapply(wq$avgdyentero1600,wq$qavgdyentero1600,function(x) max(x,na.rm=T))
labQs <-  paste(sprintf("%1.0f",10^minQs)," to ",sprintf("%1.0f",10^maxQs),sep="")
labQs <- paste("Q",1:4," (",labQs,")",sep="")

midQs <- minQs + (maxQs-minQs)/2

```



```{r,echo=FALSE}
# --------------------------------------
# Load Swallowed Water Entero 1600 
# regression output
# --------------------------------------
load("~/dropbox/13beaches/aim1-results/rawoutput/aim1-entero1600-regs-swall.Rdata")

# --------------------------------------
# Make some cross-tabs of 
# the number of swimmers and number
# of cumulative incident episodes by
# qunitile of Entero 1600 and age category
# --------------------------------------

calcNs <- function(gi,Qentero) {
  n <- tapply(gi,Qentero,sum)
  N <- tapply(gi,Qentero,function(x) length(x))
  cbind(N,n)
}

N.all <- calcNs(ad$gici3[ad$headunder=="Yes" & ad$agestrat!=""],ad$qentero1600[ad$headunder=="Yes"& ad$agestrat!=""])

N.age0to4 <- calcNs(ad$gici3[ad$headunder=="Yes" & ad$agestrat=="(0, 4]"],ad$qentero1600[ad$headunder=="Yes" & ad$agestrat=="(0, 4]"] )

N.age5to10 <- calcNs(ad$gici3[ad$headunder=="Yes" & ad$agestrat=="(4, 10]"],ad$qentero1600[ad$headunder=="Yes" & ad$agestrat=="(4, 10]"] )

N.age11plus <- calcNs(ad$gici3[ad$headunder=="Yes" & ad$agestrat==">10"],ad$qentero1600[ad$headunder=="Yes" & ad$agestrat==">10"] )

N.head <- cbind(N.all,N.age0to4,N.age5to10,N.age11plus)
rownames(N.head) <-labQs

```

\begin{table}[h!tb]
\renewcommand{\arraystretch}{1.5}
\begin{center}
\begin{minipage}{0.7\textwidth}
\caption{Number of Head Immersion Swimmers (N) and Cumulative Incident Episodes (n) of GI Illness by Quntiles of \textit{Enterococcus} EPA 1600 Concentration and Age}
\end{minipage}
\begin{tabular}{l rr rr rr rr}
& \\
\textit{Enterococcus} & \multicolumn{2}{c}{All Ages} & \multicolumn{2}{c}{Ages 0 to 4} & \multicolumn{2}{c}{Ages 5 to 10} & \multicolumn{2}{c}{Ages >10} \\
Quintile (range) & N & n & N & n & N & n & N & n \\
\hline
```{r,echo=FALSE,results='asis'}
   rowtable(N.head,digits=0)
```
\hline
\end{tabular}
\end{center}
\end{table}

```{r,echo=FALSE}

N.all <- calcNs(ad$gici3[ad$swallwater=="Yes" & ad$agestrat!=""],ad$qentero1600[ad$swallwater=="Yes"& ad$agestrat!=""])

N.age0to4 <- calcNs(ad$gici3[ad$swallwater=="Yes" & ad$agestrat=="(0, 4]"],ad$qentero1600[ad$swallwater=="Yes" & ad$agestrat=="(0, 4]"] )

N.age5to10 <- calcNs(ad$gici3[ad$swallwater=="Yes" & ad$agestrat=="(4, 10]"],ad$qentero1600[ad$swallwater=="Yes" & ad$agestrat=="(4, 10]"] )

N.age11plus <- calcNs(ad$gici3[ad$swallwater=="Yes" & ad$agestrat==">10"],ad$qentero1600[ad$swallwater=="Yes" & ad$agestrat==">10"] )

N.swall <- cbind(N.all,N.age0to4,N.age5to10,N.age11plus)
rownames(N.swall) <-labQs

```
\begin{table}[h!tb]
\renewcommand{\arraystretch}{1.5}
\begin{center}
\begin{minipage}{0.7\textwidth}
\caption{Number of Swimmers Who Swallowed Water (N) and Cumulative Incident Episodes (n) of GI Illness by Quntiles of \textit{Enterococcus} EPA 1600 Concentration and Age}
\end{minipage}
\begin{tabular}{l rr rr rr rr}
& \\
\textit{Enterococcus} & \multicolumn{2}{c}{All Ages} & \multicolumn{2}{c}{Ages 0 to 4} & \multicolumn{2}{c}{Ages 5 to 10} & \multicolumn{2}{c}{Ages >10} \\
Quintile (range) & N & n & N & n & N & n & N & n \\
\hline
```{r,echo=FALSE,results='asis'}
   rowtable(N.swall,digits=0)
```
\hline
\end{tabular}
\end{center}
\end{table}

```{r,echo=FALSE}

N.all <- calcNs(ad$gici3[ad$anycontact=="No" & ad$agestrat!=""],ad$qentero1600[ad$anycontact=="No" & ad$agestrat!=""])

N.age0to4 <- calcNs(ad$gici3[ad$anycontact=="No" & ad$agestrat=="(0, 4]"],ad$qentero1600[ad$anycontact=="No" & ad$agestrat=="(0, 4]"] )

N.age5to10 <- calcNs(ad$gici3[ad$anycontact=="No" & ad$agestrat=="(4, 10]"],ad$qentero1600[ad$anycontact=="No" & ad$agestrat=="(4, 10]"] )

N.age11plus <- calcNs(ad$gici3[ad$anycontact=="No" & ad$agestrat==">10"],ad$qentero1600[ad$anycontact=="No" & ad$agestrat==">10"] )

N.noswim <- cbind(N.all,N.age0to4,N.age5to10,N.age11plus)
rownames(N.noswim) <-labQs

```
\begin{table}[h!tb]
\renewcommand{\arraystretch}{1.5}
\begin{center}
\begin{minipage}{0.7\textwidth}
\caption{Number of Non-Swimmers (N) and Cumulative Incident Episodes (n) of GI Illness by Quntiles of \textit{Enterococcus} EPA 1600 Concentration and Age (Negative Control Exposure Analysis)}
\end{minipage}
\begin{tabular}{l rr rr rr rr}
& \\
\textit{Enterococcus} & \multicolumn{2}{c}{All Ages} & \multicolumn{2}{c}{Ages 0 to 4} & \multicolumn{2}{c}{Ages 5 to 10} & \multicolumn{2}{c}{Ages >10} \\
Quintile (range) & N & n & N & n & N & n & N & n \\
\hline
```{r,echo=FALSE,results='asis'}
   rowtable(N.swall,digits=0)
```
\hline
\end{tabular}
\end{center}
\end{table}


```{r,echo=FALSE}
# --------------------------------------
# Format Swallowed Water CIRs as text 
# and print a table
# --------------------------------------
cirformat <- function(x) {
  # x : a vector of length 3 with CIR, lb, ub
  paste(sprintf("%1.2f",x[1]), " (",sprintf("%1.2f",x[2]),", ",sprintf("%1.2f",x[3]),")",sep="")
}

fcir.all <- c("ref",apply(cir.all,2,cirformat))
fcir.age0to4 <- c("ref",apply(cir.age0to4,2,cirformat))
fcir.age5to10 <- c("ref",apply(cir.age5to10,2,cirformat))
fcir.age11plus <- c("ref",apply(cir.age11plus,2,cirformat))

fci.all <- sprintf("%1.0f",ci.all)
fci.age0to4 <- sprintf("%1.0f",ci.age0to4)
fci.age5to10 <- sprintf("%1.0f",ci.age5to10)
fci.age11plus <- sprintf("%1.0f",ci.age11plus)

cirtab <- cbind(fci.all,fcir.all,
               fci.age0to4,fcir.age0to4,
               fci.age5to10,fcir.age5to10,
               fci.age11plus,fcir.age11plus)
rownames(cirtab) <- labQs 

```

\begin{table}[h!tb]
\renewcommand{\arraystretch}{1.5}
\begin{center}
\caption{Cumlative Incidence of GI Illness Among Swimmers Who Swallowed Water by Quartiles of \textit{Enterococcus} EPA 1600 Concentration and Age}
\begin{tabular}{l cc cc cc cc}
& \\
\textit{Enterococcus} & \multicolumn{2}{c}{All Ages} & \multicolumn{2}{c}{Ages 0 to 4} & \multicolumn{2}{c}{Ages 5 to 10} & \multicolumn{2}{c}{Ages >10} \\
Quartile (range) & CI$^*$ & aCIR$^{**}$ & CI$^*$ & aCIR$^{**}$ & CI$^*$ & aCIR$^{**}$ & CI$^*$ & aCIR$^{**}$ \\
\hline
```{r,echo=FALSE,results='asis'}
   rowtable(cirtab,digits=0)
```
\hline
\end{tabular}
\end{center}

$^*$ 3-day Cumulative Incidence (CI) per 1000 \\
$^{**}$ Adjusted Cumulative Incidence Ratio (aCIR)
\end{table}


```{r,echo=FALSE}
# --------------------------------------
# Summarize Negative Control Exposure
# Analysis of Enterococcus 1600 and
# non-swimmers
# --------------------------------------
load("~/dropbox/13beaches/aim1-results/rawoutput/aim1-entero1600-regs-noswim.Rdata")

# --------------------------------------
# Format Non-Swimmer CIRs as text 
# and print a table
# --------------------------------------
cirformat <- function(x) {
  # x : a vector of length 3 with CIR, lb, ub
  paste(sprintf("%1.2f",x[1]), " (",sprintf("%1.2f",x[2]),", ",sprintf("%1.2f",x[3]),")",sep="")
}

fcir.all <- c("ref",apply(cir.all,2,cirformat))
fcir.age0to4 <- c("ref",apply(cir.age0to4,2,cirformat))
fcir.age5to10 <- c("ref",apply(cir.age5to10,2,cirformat))
fcir.age11plus <- c("ref",apply(cir.age11plus,2,cirformat))

fci.all <- sprintf("%1.0f",ci.all)
fci.age0to4 <- sprintf("%1.0f",ci.age0to4)
fci.age5to10 <- sprintf("%1.0f",ci.age5to10)
fci.age11plus <- sprintf("%1.0f",ci.age11plus)

cirtab <- cbind(fci.all,fcir.all,
               fci.age0to4,fcir.age0to4,
               fci.age5to10,fcir.age5to10,
               fci.age11plus,fcir.age11plus)
rownames(cirtab) <- labQs 

```

\begin{table}[h!tb]
\renewcommand{\arraystretch}{1.5}
\begin{center}
\caption{Negative Control Exposure Analysis: Cumlative Incidence of GI Illness Among Non-Swimmers by Quartiles of \textit{Enterococcus} EPA 1600 Concentration and Age}
\begin{tabular}{l cc cc cc cc}
& \\
\textit{Enterococcus} & \multicolumn{2}{c}{All Ages} & \multicolumn{2}{c}{Ages 0 to 4} & \multicolumn{2}{c}{Ages 5 to 10} & \multicolumn{2}{c}{Ages >10} \\
Quartile (range) & CI$^*$ & aCIR$^{**}$ & CI$^*$ & aCIR$^{**}$ & CI$^*$ & aCIR$^{**}$ & CI$^*$ & aCIR$^{**}$ \\
\hline
```{r,echo=FALSE,results='asis'}
   rowtable(cirtab,digits=0)
```
\hline
\end{tabular}
\end{center}

$^*$ 3-day Cumulative Incidence (CI) per 1000 \\
$^{**}$ Adjusted Cumulative Incidence Ratio (aCIR)
\end{table}



```{r,echo=FALSE}
# ------------------------------------------------------------------
# Entero 1600 Quartile analysis, using 10 day follow-up rather than
# 3-day follow-up
# ------------------------------------------------------------------
# --------------------------------------
# Load Entero 1600 Head Immersion 
# regression output
# --------------------------------------
load("~/dropbox/13beaches/aim1-results/rawoutput/aim1-entero1600-regs-head-10d.Rdata")

# --------------------------------------
# Format CIRs as text and print a table
# --------------------------------------
cirformat <- function(x) {
  # x : a vector of length 3 with CIR, lb, ub
  paste(sprintf("%1.2f",x[1]), " (",sprintf("%1.2f",x[2]),", ",sprintf("%1.2f",x[3]),")",sep="")
}

fcir.all <- c("ref",apply(cir.all,2,cirformat))
fcir.age0to4 <- c("ref",apply(cir.age0to4,2,cirformat))
fcir.age5to10 <- c("ref",apply(cir.age5to10,2,cirformat))
fcir.age11plus <- c("ref",apply(cir.age11plus,2,cirformat))

fci.all <- sprintf("%1.0f",ci.all)
fci.age0to4 <- sprintf("%1.0f",ci.age0to4)
fci.age5to10 <- sprintf("%1.0f",ci.age5to10)
fci.age11plus <- sprintf("%1.0f",ci.age11plus)

# --------------------------------------
# Summarize 
# the number of swimmers and number
# of cumulative incident episodes by
# qunitile of Entero 1600 and age category
# --------------------------------------
calcNs <- function(gi,Qentero) {
  n <- tapply(gi,Qentero,sum)
  N <- tapply(gi,Qentero,function(x) length(x))
  cbind(n,N)
}

N.all <- calcNs(ad$gici10[ad$headunder=="Yes" & ad$agestrat!=""],ad$qentero1600[ad$headunder=="Yes"& ad$agestrat!=""])

N.age0to4 <- calcNs(ad$gici10[ad$headunder=="Yes" & ad$agestrat=="(0, 4]"],ad$qentero1600[ad$headunder=="Yes" & ad$agestrat=="(0, 4]"] )

N.age5to10 <- calcNs(ad$gici10[ad$headunder=="Yes" & ad$agestrat=="(4, 10]"],ad$qentero1600[ad$headunder=="Yes" & ad$agestrat=="(4, 10]"] )

N.age11plus <- calcNs(ad$gici10[ad$headunder=="Yes" & ad$agestrat==">10"],ad$qentero1600[ad$headunder=="Yes" & ad$agestrat==">10"] )

# format them to a single text string
Nformat <- function(Ns) {
  paste(Ns[,1],"/",Ns[,2],sep="")
}
fN.all <- Nformat(N.all)
fN.age0to4 <- Nformat(N.age0to4)
fN.age5to10 <- Nformat(N.age5to10)
fN.age11plus <- Nformat(N.age11plus)

# --------------------------------------
# Put all of the Ns and CIRs into
# a single table
# --------------------------------------
cirtab <- cbind(fN.all,fcir.all,
               fN.age0to4,fcir.age0to4,
               fN.age5to10,fcir.age5to10,
               fN.age11plus,fcir.age11plus)
rownames(cirtab) <- labQs 

```

\clearpage
\blandscape
\begin{table}[h!tb]
\renewcommand{\arraystretch}{1.5}
\begin{center}
\caption{Cumlative Incidence of GI Illness Among Head Immersion Swimmers by Quartiles of \textit{Enterococcus} EPA 1600 Concentration and Age}
\begin{tabular}{l rc rc rc rc}
& \\
\textit{Enterococcus} & \multicolumn{2}{c}{All Ages} & \multicolumn{2}{c}{Ages 0 to 4} & \multicolumn{2}{c}{Ages 5 to 10} & \multicolumn{2}{c}{Ages >10} \\
Quartile & Cases$^*$/ & aCIR$^{**}$ & Cases$^*$/  & aCIR$^{**}$ & Cases$^*$/  & aCIR$^{**}$ & Cases$^*$/ & aCIR$^{**}$ \\
(range CFU/100ml) & At Risk & & At Risk & & At Risk & & At Risk \\
\hline
```{r,echo=FALSE,results='asis'}
   rowtable(cirtab,digits=0)
```
\hline
\end{tabular}
\end{center}

$^*$ 3-day Cumulative Incident (CI) cases of gastrointestinal illness \\
$^{**}$ Adjusted Cumulative Incidence Ratio (aCIR)
\end{table}
\elandscape



