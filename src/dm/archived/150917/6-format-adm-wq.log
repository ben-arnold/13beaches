---------------------------------------------------------------------------------------------
      name:  <unnamed>
       log:  /Users/jadederong/dropbox/13beaches/src/dm/6-format-adm-wq.log
  log type:  text
 opened on:  28 Aug 2015, 11:43:56

. 
. *----------------------------------------
. * 6-format-adm-wq.do
. * ben arnold
. *
. * format the Avalon, Doheny, Malibu
. * water quality data.
. * 
. * calculate log averages using a standardized
. * imputation approach for values at 
. * the detection limits
. * for values below LOD, use 0.1, consistent with NEEAR data
. * for values at upper LOD, use upper LOD
. *
. * Only include Entero 1600 and QPCR
. * for comparability to the NEEAR data
. *
. * version 6 (28 aug 2015)
. * recorded f- coliphage epa 1602 values of "1" to values of "-1" at  
. * malibu (confirmation from john griffiths required)
. *
. * version 5 (7 aug 2015)
. * major re-write to output an individual sample dataset
. *
. * version 4 (17 apr 2015)
. * Further split out site E at Doheny as a separate water quality site
. *
. * version 3 (21 feb 2015)
. * created a separate site-specific match for each beach. At Avalon
. * since site D is so different + geographically separate from A/B/C 
. * (see Figs 1 and 2 of Yau et al. 2014)
. * At Doheny and Malibu, Site C was in the lagoon.
. *
. * version 2 (13 feb 2015)
. * add Coliphage indicator variables for EPA 1601 and 1602
. *
. * version 1 (25 feb 2014)
. *
. *----------------------------------------
. 
. *----------------------------------------
. * input files:
. *       avalon_inddata.dta
. *   doheny_inddata.dta
. *   malibu_inddata.dta
. *
. * output files:
. *       adm-wq.dta
. *
. *----------------------------------------
. 
. 
. *----------------------------------------
. * read in the beaches indicator data
. * create an indicator code that 
. * excludes beach and year info
. *----------------------------------------
. use "~/dropbox/13beaches/data/untouched/adm/avalon_inddata.dta", clear

. gen indcode = substr(groupindex,1,8) + substr(groupindex,13,1)

. keep if inlist(indcode,"02ENT2411","02ENT2412","02ENT2413","02ENT2414","12ENT0411","14FMC05
> 11","16FMC0811","14FPC0511","16FPC0811")
(18,954 observations deleted)

. tempfile avalon

. save `avalon'
file /var/folders/gh/bgfnnwkd7wdg7cw3q0_zwvt40000gp/T//S_25890.000001 saved

. 
. use "~/dropbox/13beaches/data/untouched/adm/doheny_inddata.dta", clear

. gen indcode = substr(groupindex,1,8) + substr(groupindex,13,1)

. keep if inlist(indcode,"02ENT2411","02ENT2412","02ENT2413","02ENT2414","15ENT0411","14FMC05
> 11","16FMC0811","14FPC0511","16FPC0811")
(10,217 observations deleted)

. tempfile doheny

. save `doheny'
file /var/folders/gh/bgfnnwkd7wdg7cw3q0_zwvt40000gp/T//S_25890.000002 saved

. 
. use "~/dropbox/13beaches/data/untouched/adm/malibu_inddata.dta", clear

. gen indcode = substr(groupindex,1,8) + substr(groupindex,13,1)

. keep if inlist(indcode,"02ENT2411","02ENT2412","02ENT2413","02ENT2414","12ENT0411","14FMC05
> 11","16FMC0811","14FPC0511","16FPC0811")
(10,233 observations deleted)

. 
. append using `avalon'
(note: variable sampleid was str6, now str8 to accommodate using data's values)
(note: variable qualifier was str2, now str5 to accommodate using data's values)
(note: variable labcode was str7, now str8 to accommodate using data's values)
(note: variable comments was str55, now str66 to accommodate using data's values)
(label lsampletime already defined)

. append using `doheny'
(note: variable comments was str66, now str124 to accommodate using data's values)
(label lsampletime already defined)

. 
. * standardize the EPA 1600 indicator code for Doheny
. replace indcode = "12ENT0411" if indcode=="15ENT0411"
(441 real changes made)

. 
. tab indcode beach

           |              Beach
   indcode |    Avalon     Doheny     Malibu |     Total
-----------+---------------------------------+----------
 02ENT2411 |       560        334        337 |     1,231 
 02ENT2412 |       623        338        346 |     1,307 
 02ENT2413 |       560        334        337 |     1,231 
 02ENT2414 |       622        338        346 |     1,306 
 12ENT0411 |       705        441        381 |     1,527 
 14FMC0511 |       318        101          0 |       419 
 14FPC0511 |       608        427        177 |     1,212 
 16FMC0811 |       395        234        195 |       824 
 16FPC0811 |       395        234        195 |       824 
-----------+---------------------------------+----------
     Total |     4,786      2,781      2,314 |     9,881 


. 
. *----------------------------------------
. * Create a standard beach code for Avalon
. * to differentiate sites A/B/C from site D
. * and in Doheny/Malibu to differentiate site C
. * (in the lagoon) from the other sites
. *----------------------------------------
. gen str beachcode = ""
(9,881 missing values generated)

.         replace beachcode = "Avalon-ABC" if beach=="Avalon" & stationid!="A_D"
variable beachcode was str1 now str10
(4,546 real changes made)

.         replace beachcode = "Avalon-D" if beach=="Avalon" & stationid=="A_D"
(240 real changes made)

.         replace beachcode= "Doheny-ABD" if beach=="Doheny" & (stationid!="D_C" & stationid!
> ="D_E")
(1,910 real changes made)

.         replace beachcode= "Doheny-C" if beach=="Doheny" & stationid=="D_C"
(241 real changes made)

.         replace beachcode= "Doheny-E" if beach=="Doheny" & stationid=="D_E"
(630 real changes made)

.         replace beachcode= "Malibu-ABDE" if beach=="Malibu" & stationid!="M_C"
variable beachcode was str10 now str11
(2,013 real changes made)

.         replace beachcode= "Malibu-C" if beach=="Malibu" & stationid=="M_C"
(301 real changes made)

.         assert beachcode!= ""

.         label var beachcode "Water quality sampling location beach code"

. 
.         
.         
. *----------------------------------------
. * create some standard variables
. * consistent with the NEEAR water quality
. * dataset
. *----------------------------------------
. rename sampledate coldate

.         
. gen coltime = 8 if inlist(sampletime,"07:00:00","08:00:00")
(5,363 missing values generated)

.         replace coltime = 11 if inlist(sampletime,"12:00:00","13:00:00")
(3,423 real changes made)

.         replace coltime = 15 if inlist(sampletime,"15:00:00")
(1,940 real changes made)

.         label var coltime "Sample collection time (approx)"

.         
. 
. gen depth = 1 if sampledepth==0.5
(696 missing values generated)

.         replace depth = 2 if sampledepth==1
(696 real changes made)

.         label var depth "Sample depth"

.         capture drop label depth

.         label define depth 1 "Shin depth" 2 "Waist depth"

.         label values depth depth

. 
.         
. *----------------------------------------
. * There are 35 duplicate samples in
. * Malibu that are lab replicates
. * Identify them, drop any that are NDs
. * and then average the others
. *----------------------------------------
. duplicates report beach stationid beachcode coldate coltime depth indcode

Duplicates in terms of beach stationid beachcode coldate coltime depth indcode

--------------------------------------
   copies | observations       surplus
----------+---------------------------
        1 |         9811             0
        2 |           70            35
--------------------------------------

. duplicates tag beach stationid beachcode coldate coltime depth indcode, gen(dups)

Duplicates in terms of beach stationid beachcode coldate coltime depth indcode

. tab beach dups

           |         dups
     Beach |         0          1 |     Total
-----------+----------------------+----------
    Avalon |     4,786          0 |     4,786 
    Doheny |     2,781          0 |     2,781 
    Malibu |     2,244         70 |     2,314 
-----------+----------------------+----------
     Total |     9,811         70 |     9,881 


. drop if dups==1 & qualifier=="<"
(7 observations deleted)

. bysort beach stationid beachcode coldate coltime depth indcode: egen _x = mean(result)

. replace result = _x if dups==1
(52 real changes made)

. bysort beach stationid beachcode coldate coltime depth indcode: keep if _n==1
(29 observations deleted)

. drop _x

. duplicates report beach stationid beachcode coldate coltime depth indcode

Duplicates in terms of beach stationid beachcode coldate coltime depth indcode

--------------------------------------
   copies | observations       surplus
----------+---------------------------
        1 |         9845             0
--------------------------------------

. 
. 
. *----------------------------------------
. * reshape the data from long to wide
. *----------------------------------------
. rename qualifier nd

. keep beach stationid beachcode sampleid coldate coltime depth nd result indcode

. 
. reshape wide result nd, i(beach stationid beachcode sampleid coldate coltime depth) j(indco
> de, string)
(note: j = 02ENT2411 02ENT2412 02ENT2413 02ENT2414 12ENT0411 14FMC0511 14FPC0511 16FMC0811 16
> FPC0811)

Data                               long   ->   wide
-----------------------------------------------------------------------------
Number of obs.                     9845   ->    1493
Number of variables                  10   ->      25
j variable (9 values)           indcode   ->   (dropped)
xij variables:
                                 result   ->   result02ENT2411 result02ENT2412 ... result16FP
> C0811
                                     nd   ->   nd02ENT2411 nd02ENT2412 ... nd16FPC0811
-----------------------------------------------------------------------------

. 
. 
. *----------------------------------------
. * rename the variables so they are no longer encoded
. *----------------------------------------
. 
. local codenames "02ENT2411 02ENT2412 02ENT2413 02ENT2414 12ENT0411 14FMC0511 16FMC0811 14FP
> C0511 16FPC0811"

. local newnames "enteroQPCRcce enteroQPCRcce2 enteroQPCRcce3 enteroQPCRcce4 entero1600cfu fm
> c1601mpn fmc1602mpn fpc1601mpn fpc1602mpn"

. capture label drop ND

. label define ND 0 "Detected" 1 "Below detection"

. local i = 1

. foreach var of local codenames {
  2.         local newname = word("`newnames'",`i')
  3.         gen `newname' =  result`var'
  4.         gen byte `newname'_nd = 1 if (nd`var'!="" & nd`var'!=">") | (`newname'==0)
  5.                 replace `newname'_nd = 0 if `newname'_nd==. & `newname' !=.
  6.                 label values `newname'_nd ND
  7.         replace `newname' = 0 if `newname'_nd==1
  8.         local i = `i'+1
  9. }
(262 missing values generated)
(1,293 missing values generated)
(1,031 real changes made)
(57 real changes made)
(186 missing values generated)
(1,274 missing values generated)
(1,088 real changes made)
(64 real changes made)
(262 missing values generated)
(1,293 missing values generated)
(1,031 real changes made)
(57 real changes made)
(187 missing values generated)
(1,274 missing values generated)
(1,087 real changes made)
(64 real changes made)
(2 missing values generated)
(1,208 missing values generated)
(1,206 real changes made)
(285 real changes made)
(1,074 missing values generated)
(1,290 missing values generated)
(216 real changes made)
(203 real changes made)
(669 missing values generated)
(1,113 missing values generated)
(444 real changes made)
(379 real changes made)
(281 missing values generated)
(1,001 missing values generated)
(720 real changes made)
(492 real changes made)
(669 missing values generated)
(709 missing values generated)
(40 real changes made)
(784 real changes made)

. 
. drop nd* result*

. 
. 
. label var enteroQPCRcce  "Entero EPA 1611 qPCR ddct CCE/100ml"

. label var enteroQPCRcce2 "Entero EPA 1611 qPCR ddct CCE/100ml (w/inhib)"

. label var enteroQPCRcce3 "Entero EPA 1611 qPCR dct CCE/100ml"

. label var enteroQPCRcce4 "Entero EPA 1611 qPCR dct CCE/100ml (w/inhib)"

. label var entero1600cfu  "Entero EPA 1600 CFU/100ml"

. label var fpc1601mpn "F+ Coliphage EPA 1601 MPN/100ml"

. label var fpc1602mpn "F+ Coliphage EPA 1602 MPN/100ml"

. label var fmc1601mpn "F- Coliphage EPA 1601 MPN/100ml"

. label var fmc1602mpn "F- Coliphage EPA 1602 MPN/100ml"

. foreach var of local newnames {
  2.         local vlab : var lab `var'
  3.         label var `var'_nd "`vlab', below detection"
  4. }

. 
. 
. *----------------------------------------
. * Final variable cleanup / reorder
. *----------------------------------------
. 
. * for one value at Doheny, replace a 0.09 F+ Coliphage 1601 value with ND
. replace fpc1601mpn_nd = 1 if (fpc1601mpn>0 & fpc1601mpn<0.1) & beach=="Doheny"
(1 real change made)

. replace fpc1601mpn    = 0 if (fpc1601mpn>0 & fpc1601mpn<0.1) & beach=="Doheny"
(1 real change made)

. 
. * recode "1" values to "-1" for f- coliphage epa 1602 at malibu
. replace fmc1602mpn = -1 if fmc1602mpn == 1 & beach=="Malibu"
(159 real changes made)

. replace fmc1602mpn_nd = 1 if fmc1602mpn == -1 & beach=="Malibu"
(159 real changes made)

. 
. 
. order beach beachcode stationid sampleid coldate coltime depth

. notes: Values below the detection limit for all indictors are set to 0

. notes: Values are missing if a sample was not tested for a particular indicator

. label data "Avalon/Doheny/Malibu water sample data, formatted by 6-format-adm-wq.do"

. save "~/dropbox/13beaches/data/final/adm-wq-samples.dta", replace
file ~/dropbox/13beaches/data/final/adm-wq-samples.dta saved

. outsheet using "~/dropbox/13beaches/data/final/adm-wq-samples.csv", comma replace

. 
. 
. *----------------------------------------
. * Calculate daily average values for
. * Entero 1600
. * Entero QPCR 1611 ddct
. * F-plus Coliphage 1601
. * F-plus Coliphage 1602
. * F-minus Coliphage 1601
. * F-minus Coliphage 1602
. *----------------------------------------
. 
. use "~/dropbox/13beaches/data/final/adm-wq-samples.dta", clear
(Avalon/Doheny/Malibu water sample data, formatted by 6-format-adm-wq.do)

. 
. 
. * impute non-detects with 0.1
. local vars "entero1600cfu enteroQPCRcce fpc1601mpn fpc1602mpn fmc1601mpn fmc1602mpn"

. foreach var of local vars {
  2.         di as res _n "Replacements of `var'"
  3.         replace `var' = 0.1 if `var'_nd==1
  4. }

Replacements of entero1600cfu
(285 real changes made)

Replacements of enteroQPCRcce
(200 real changes made)

Replacements of fpc1601mpn
(493 real changes made)

Replacements of fpc1602mpn
(784 real changes made)

Replacements of fmc1601mpn
(203 real changes made)

Replacements of fmc1602mpn
(539 real changes made)

. 
. gen logentero1600 = log10(entero1600cfu)
(2 missing values generated)

.         label var logentero1600 "log10 Entero EPA 1600"

. gen logenteropcr = log10(enteroQPCRcce)
(262 missing values generated)

.         label var logenteropcr "log10 Entero qPCR EPA 1611"

. gen logfpc1601 = log10(fpc1601mpn)
(281 missing values generated)

.         label var logfpc1601 "log10 F+ Coliphage EPA 1601"

. gen logfpc1602 = log10(fpc1602mpn)
(669 missing values generated)

.         label var logfpc1602 "log10 F+ Coliphage EPA 1602"

. gen logfmc1601 = log10(fmc1601mpn)
(1,074 missing values generated)

.         label var logfmc1601 "log10 F- Coliphage EPA 1601"

. gen logfmc1602 = log10(fmc1602mpn)
(669 missing values generated)

.         label var logfmc1602 "log10 F- Coliphage EPA 1602"

.         
. local stubs "entero1600 enteropcr fpc1601 fpc1602 fmc1601 fmc1602"

. foreach stub of local stubs {
  2.         sort beach beachcode coldate
  3.         by beach beachcode coldate: egen _dy = mean(log`stub')
  4.         by beach beachcode coldate: egen _am = mean(log`stub') if coltime==8
  5.         by beach beachcode coldate: egen _md = mean(log`stub') if coltime==11
  6.         by beach beachcode coldate: egen _pm = mean(log`stub') if coltime==15
  7.         * not doing shin + waist summaries for these beaches - waist only collected
.         * for a few samples from Avalon
.         * by beach beachcode coldate: egen _sh = mean(log`stub') if depth==1
.         * by beach beachcode coldate: egen _wt = mean(log`stub') if depth==2
.         by beach beachcode coldate: egen avgdy`stub' = max(_dy)
  8.         by beach beachcode coldate: egen avgam`stub' = max(_am)
  9.         by beach beachcode coldate: egen avgmd`stub' = max(_md)
 10.         by beach beachcode coldate: egen avgpm`stub' = max(_pm)
 11.         * by beach beachcode coldate: egen avgsh`stub' = max(_sh)
.         * by beach beachcode coldate: egen avgwt`stub' = max(_wt)
.         drop _dy - _pm
 12.         local stublab : var label log`stub'
 13.         label var avgdy`stub' "Daily Avg `stublab'"
 14.         label var avgam`stub' "AM Avg `stublab'"
 15.         label var avgmd`stub' "Mid-Day Avg `stublab'"
 16.         label var avgpm`stub' "PM Avg `stublab'"
 17.         * label var avgsh`stub' "shin Avg `stublab'"
.         * label var avgwt`stub' "waist Avg `stublab'"
. }
(1 missing value generated)
(847 missing values generated)
(954 missing values generated)
(1186 missing values generated)
(1 missing value generated)
(1 missing value generated)
(107 missing values generated)
(410 missing values generated)
(114 missing values generated)
(902 missing values generated)
(987 missing values generated)
(1218 missing values generated)
(114 missing values generated)
(132 missing values generated)
(206 missing values generated)
(506 missing values generated)
(20 missing values generated)
(858 missing values generated)
(1112 missing values generated)
(1194 missing values generated)
(20 missing values generated)
(20 missing values generated)
(431 missing values generated)
(434 missing values generated)
(846 missing values generated)
(1212 missing values generated)
(1290 missing values generated)
(731 missing values generated)
(722 missing values generated)
(984 missing values generated)
(1291 missing values generated)
(1299 missing values generated)
(1382 missing values generated)
(984 missing values generated)
(984 missing values generated)
(992 missing values generated)
(998 missing values generated)
(846 missing values generated)
(1212 missing values generated)
(1290 missing values generated)
(731 missing values generated)
(722 missing values generated)

. 
. 
. by beach beachcode coldate: keep if _n==1
(1,226 observations deleted)

. keep beach beachcode coldate avg*

. 
. gen byte marine = 1

.         label var marine "Marine beach"

. 
. order beach beachcode coldate marine

. sort beach beachcode coldate

. 
. *----------------------------------------
. * save a daily average dataset
. *----------------------------------------
. note: samples below detection were imputed with 0.1 before calculating log10 averages

. compress
  variable avgmdfpc1602 was float now byte
  variable avgpmfpc1602 was float now byte
  (1,602 bytes saved)

. label data "Avalon/Doheny/Malibu daily average water quality data, created by 6-format-adm-
> wq.do"
note: label truncated to 80 characters

. save "~/dropbox/13beaches/data/final/adm-wq.dta", replace
file ~/dropbox/13beaches/data/final/adm-wq.dta saved

. outsheet using "~/dropbox/13beaches/data/final/adm-wq.csv", comma replace

. 
. desc

Contains data from ~/dropbox/13beaches/data/final/adm-wq.dta
  obs:           267                          Avalon/Doheny/Malibu daily average water
                                                quality data, created by 6-format-adm-w
 vars:            28                          28 Aug 2015 11:43
 size:        29,370                          (_dta has notes)
---------------------------------------------------------------------------------------------
              storage   display    value
variable name   type    format     label      variable label
---------------------------------------------------------------------------------------------
beach           str6    %9s                   Beach
beachcode       str11   %11s                  Water quality sampling location beach code
coldate         int     %d                    Sample date
marine          byte    %8.0g                 Marine beach
avgdyentero1600 float   %9.0g                 Daily Avg log10 Entero EPA 1600
avgamentero1600 float   %9.0g                 AM Avg log10 Entero EPA 1600
avgmdentero1600 float   %9.0g                 Mid-Day Avg log10 Entero EPA 1600
avgpmentero1600 float   %9.0g                 PM Avg log10 Entero EPA 1600
avgdyenteropcr  float   %9.0g                 Daily Avg log10 Entero qPCR EPA 1611
avgamenteropcr  float   %9.0g                 AM Avg log10 Entero qPCR EPA 1611
avgmdenteropcr  float   %9.0g                 Mid-Day Avg log10 Entero qPCR EPA 1611
avgpmenteropcr  float   %9.0g                 PM Avg log10 Entero qPCR EPA 1611
avgdyfpc1601    float   %9.0g                 Daily Avg log10 F+ Coliphage EPA 1601
avgamfpc1601    float   %9.0g                 AM Avg log10 F+ Coliphage EPA 1601
avgmdfpc1601    float   %9.0g                 Mid-Day Avg log10 F+ Coliphage EPA 1601
avgpmfpc1601    float   %9.0g                 PM Avg log10 F+ Coliphage EPA 1601
avgdyfpc1602    float   %9.0g                 Daily Avg log10 F+ Coliphage EPA 1602
avgamfpc1602    float   %9.0g                 AM Avg log10 F+ Coliphage EPA 1602
avgmdfpc1602    byte    %9.0g                 Mid-Day Avg log10 F+ Coliphage EPA 1602
avgpmfpc1602    byte    %9.0g                 PM Avg log10 F+ Coliphage EPA 1602
avgdyfmc1601    float   %9.0g                 Daily Avg log10 F- Coliphage EPA 1601
avgamfmc1601    float   %9.0g                 AM Avg log10 F- Coliphage EPA 1601
avgmdfmc1601    float   %9.0g                 Mid-Day Avg log10 F- Coliphage EPA 1601
avgpmfmc1601    float   %9.0g                 PM Avg log10 F- Coliphage EPA 1601
avgdyfmc1602    float   %9.0g                 Daily Avg log10 F- Coliphage EPA 1602
avgamfmc1602    float   %9.0g                 AM Avg log10 F- Coliphage EPA 1602
avgmdfmc1602    float   %9.0g                 Mid-Day Avg log10 F- Coliphage EPA 1602
avgpmfmc1602    float   %9.0g                 PM Avg log10 F- Coliphage EPA 1602
---------------------------------------------------------------------------------------------
Sorted by: beach  beachcode  coldate

. 
. log close
      name:  <unnamed>
       log:  /Users/jadederong/dropbox/13beaches/src/dm/6-format-adm-wq.log
  log type:  text
 closed on:  28 Aug 2015, 11:43:57
---------------------------------------------------------------------------------------------
