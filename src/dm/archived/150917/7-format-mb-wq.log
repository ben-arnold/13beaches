--------------------------------------------------------------------------------
      name:  <unnamed>
       log:  /Users/benarnold/dropbox/13beaches/src/dm/7-format-mb-wq.log
  log type:  text
 opened on:  17 Sep 2015, 14:21:30

. 
. 
. *----------------------------------------
. * 7-format-mb-wq.do
. * ben arnold
. *
. * format the Mission Bay water quality data
. * water quality data.
. * 
. * calculate log averages using a standardized
. * imputation approach for values at 
. * the detection limits
. * for values below LOD, use LOD/2
. * for values at upper LOD, use upper LOD
. *
. * version 4 (17 sep 2015)
. * caught a small number of 0 qPCR samples
. * that should be flagged as NDs but were not
. *
. * version 3 (19 aug 2015)
. * major re-write to generate a sample-specific dataset
. * 
. * version 2 (21 feb 2015)
. * updated the beach code
. *
. * version 1 (3 feb 2015)
. *
. *----------------------------------------
. 
. 
. 
. *------------------------------------------
. * load the culture method sample data
. * and prune out empty rows
. *------------------------------------------
. 
. insheet using "~/dropbox/13beaches/data/untouched/missionbay/wq/tblMicrobiolog
> yData.csv", comma clear
(10 vars, 12,636 obs)

. 
. ren station stationid

. 
. * confirm Entero EPA 1600 and E.coli IDEXX and Total Coliforms IDEXX 
. * were only run on composite samples, then drop non-composite records
. assert result == -99 if analysismethod=="EPA 1600" & strpos(stationid,"COMP")=
> =0

. assert result == -99 if parametercode=="E. Coli" & analysismethod=="Colilert (
> 96 Well Tray)" & strpos(stationid,"COMP")==0

. assert result == -99 if parametercode=="Total Coliforms" & analysismethod=="Co
> lilert (96 Well Tray)" & strpos(stationid,"COMP")==0

. 
. drop if analysismethod=="EPA 1600" & strpos(stationid,"COMP")==0
(1,944 observations deleted)

. drop if parametercode=="E. Coli" & analysismethod=="Colilert (96 Well Tray)" &
>  strpos(stationid,"COMP")==0
(1,944 observations deleted)

. drop if parametercode=="Total Coliforms" & analysismethod=="Colilert (96 Well 
> Tray)" & strpos(stationid,"COMP")==0
(1,944 observations deleted)

. 
. * confirm Entero Enterolert IDEXX, MF-Fecal Colif and MF-Total COlif 
. * were not run on composite samples, then drop those composite records
. assert result == -99 if parametercode=="Enterococcus" & analysismethod=="Colil
> ert (96 Well Tray)" & strpos(stationid,"COMP")>0

. assert result == -99 if parametercode=="Fecal Coliforms" & analysismethod=="MF
> -Fecal Coliform (APHA 9" & strpos(stationid,"COMP")>0

. assert result == -99 if parametercode=="Total Coliforms" & analysismethod=="MF
> -Total Coliform (APHA 9" & strpos(stationid,"COMP")>0

. 
. drop if parametercode=="Enterococcus" & analysismethod=="Colilert (96 Well Tra
> y)" & strpos(stationid,"COMP")>0
(162 observations deleted)

. drop if parametercode=="Fecal Coliforms" & analysismethod=="MF-Fecal Coliform 
> (APHA 9" & strpos(stationid,"COMP")>0
(162 observations deleted)

. drop if parametercode=="Total Coliforms" & analysismethod=="MF-Total Coliform 
> (APHA 9" & strpos(stationid,"COMP")>0
(162 observations deleted)

. 
. * extract sample date
. gen coldate = date(substr(sampledate,1,8),"MDY",2020)

.         format coldate %d

.         label var coldate "Sample collection date"

. 
.         
. *------------------------------------------
. * Create indicator stub names and
. * then reshape the data to wide format
. *------------------------------------------     
. 
. keep stationid coldate sampletime parametercode qualifier result units analysi
> smethod

. order stationid coldate sampletime parametercode qualifier result units analys
> ismethod

. 
. * compress indicator and analysis method into a single field for reshaping
. gen ind = "entero1600cfu" if analysismethod=="EPA 1600"
(6,156 missing values generated)

.         replace ind = "enteroELTmpn" if parametercode=="Enterococcus" & analys
> ismethod=="Colilert (96 Well Tray)"
(1,944 real changes made)

.         replace ind = "ecoliCLTmpn" if parametercode=="E. Coli" & analysismeth
> od=="Colilert (96 Well Tray)"
(162 real changes made)

.         replace ind = "tcolCLTmpn" if parametercode=="Total Coliforms" & analy
> sismethod=="Colilert (96 Well Tray)"
(162 real changes made)

.         replace ind = "fcolifcfu" if parametercode=="Fecal Coliforms" & analys
> ismethod=="MF-Fecal Coliform (APHA 9"
(1,944 real changes made)

.         replace ind = "tcolifcfu" if parametercode=="Total Coliforms" & analys
> ismethod=="MF-Total Coliform (APHA 9"
(1,944 real changes made)

.         assert ind!=""

.         
. keep stationid coldate sampletime ind result qualifier

. order stationid coldate sampletime ind result qualifier

. 
. sort stationid coldate sampletime 

. reshape wide result qualifier, i(stationid coldate sampletime) j(ind, string)
(note: j = ecoliCLTmpn entero1600cfu enteroELTmpn fcolifcfu tcolCLTmpn tcolifcfu
> )

Data                               long   ->   wide
-----------------------------------------------------------------------------
Number of obs.                     6318   ->    2106
Number of variables                   6   ->      15
j variable (6 values)               ind   ->   (dropped)
xij variables:
                                 result   ->   resultecoliCLTmpn resultentero160
> 0cfu ... resulttcolifcfu
                              qualifier   ->   qualifierecoliCLTmpn qualifierent
> ero1600cfu ... qualifiertcolifcfu
-----------------------------------------------------------------------------

. 
. *------------------------------------------
. * Flag non-detect values and set them to 0
. * to be consistent with other datasets
. *------------------------------------------     
. 
. label define ND 0 "Detected" 1 "Below detection"

. local vars "entero1600cfu enteroELTmpn ecoliCLTmpn tcolCLTmpn fcolifcfu tcolif
> cfu"

. foreach var of local vars  {
  2.         rename result`var' `var'
  3.         gen `var'_nd = 1 if inlist(qualifier`var',"<","ND")
  4.                 replace `var'_nd = 0 if (`var'!=.) & (`var'_nd==.)
  5.                 label values `var'_nd ND
  6.         replace `var' = 0 if `var'_nd==1
  7.                 
.         
. }
(2,076 missing values generated)
(132 real changes made)
(30 real changes made)
(1,479 missing values generated)
(1,317 real changes made)
(627 real changes made)
(2,095 missing values generated)
(151 real changes made)
(11 real changes made)
(2,102 missing values generated)
(158 real changes made)
(4 real changes made)
(1,760 missing values generated)
(1,598 real changes made)
(346 real changes made)
(1,249 missing values generated)
(1,087 real changes made)
(857 real changes made)

. drop qualifier*

. order stationid coldate sampletime enteroELT* fcolif* tcolif* entero1600* ecol
> iCLT*

. 
. *------------------------------------------
. * Label variables and add notes
. *------------------------------------------
. 
. * data cleaning: there is a single sample with a missing collection time
. * the time is 1245 based on the qPCR data (identified when merging)
. replace sampletime = 1245 if sampletime==. & stationid=="LL3C" & coldate==mdy(
> 6,29,2003)
(1 real change made)

. 
. gen sampletype = "Hourly sample"

.         replace sampletype = "Daily composite sample" if strpos(stationid,"COM
> P")>0
variable sampletype was str13 now str22
(162 real changes made)

.         assert sampletype!=""

.         label var sampletype "Water sample type"

.         tab stationid sampletype

           |   Water sample type
   Station | Daily c..  Hourly .. |     Total
-----------+----------------------+----------
      BC6A |         0        108 |       108 
      BC6B |         0        108 |       108 
      BC6C |         0        108 |       108 
    COMP1X |        27          0 |        27 
    COMP2X |        27          0 |        27 
    COMP3X |        27          0 |        27 
    COMP4X |        27          0 |        27 
    COMP5X |        27          0 |        27 
    COMP6X |        27          0 |        27 
     CPS5A |         0        108 |       108 
     CPS5B |         0        108 |       108 
     CPS5C |         0        108 |       108 
     DAC4A |         0        108 |       108 
     DAC4B |         0        108 |       108 
      LL3A |         0        108 |       108 
      LL3B |         0        108 |       108 
      LL3C |         0        108 |       108 
      LL3D |         0        108 |       108 
      LL3E |         0        108 |       108 
      TS2A |         0        108 |       108 
      TS2B |         0        108 |       108 
      TS2C |         0        108 |       108 
     VCB1A |         0        108 |       108 
     VCB1B |         0        108 |       108 
-----------+----------------------+----------
     Total |       162      1,944 |     2,106 


. 
. rename sampletime coltime

. label var coltime "Sample collection time"

. label var enteroELTmpn "Enterococcus, Enterolert MPN/100ml"

. label var enteroELTmpn_nd "Enterococcus, Enterolert below detection"

. label var fcolifcfu "Fecal coliform, APHA 9222D CFU/100ml"

. label var fcolifcfu_nd "Fecal coliform, APHA 9222D below detection"

. label var tcolifcfu "Total coliform, APHA 9222B CFU/100ml"

. label var tcolifcfu_nd "Total coliform, APHA 9222B below detection"

. label var entero1600cfu "Enterococcus, EPA 1600 CFU/100ml"

. label var ecoliCLTmpn "E. coli, Colilert MPN/100ml"

. label var ecoliCLTmpn "E. coli, Colilert below detection"

. label var tcolCLTmpn "Total coliform, Colilert MPN/100ml"

. label var tcolCLTmpn_nd "Total coliform, Colilert below detection"

. 
. tempfile culture

. save `culture'
file /var/folders/bp/zslz_kn157v3zs98sv57pflc0000gn/T//S_00741.000001 saved

. 
. *------------------------------------------
. * load the qPCR sample data
. *------------------------------------------
. 
. insheet using "~/dropbox/13beaches/data/untouched/missionbay/wq/PCR Data All.c
> sv", comma clear
(10 vars, 1,580 obs)

. 
. * extract sample date
. gen coldate = date(substr(sampledate,1,8),"MDY",2020)

.         format coldate %d

.         label var coldate "Sample collection date"

. 
.         
. *------------------------------------------
. * There are 34 sets of duplicates in the data
. * Aug 19, 2015
. * Discussed this issue with John Griffith
. * at SCCWRP, and he said that if there are
. * duplicates that they are replicates and
. * should be retained in the dataset
. * (not dropped).  He suggested taking the
. * average of the replicates, so that's
. * what we are doing here, imputing at 0.1
. * for non-detects before averaging.
. *------------------------------------------     
. 
. * Identify the duplicates
. ren station stationid

. sort stationid sampledate sampletime parametercode

. duplicates report stationid sampledate sampletime parametercode

Duplicates in terms of stationid sampledate sampletime parametercode

--------------------------------------
   copies | observations       surplus
----------+---------------------------
        1 |         1512             0
        2 |           68            34
--------------------------------------

. duplicates tag stationid sampledate sampletime parametercode, gen(dups)

Duplicates in terms of stationid sampledate sampletime parametercode

. 
. * calculate the average for each stationid / date / time / assay
. gen impres = result

.         replace impres = 0.1 if inlist(qualifier,"<","ND")
(340 real changes made)

. gen logimpres = log(impres)
(29 missing values generated)

. by stationid sampledate sampletime parametercode: egen mulogimpres = mean(logi
> mpres)
(28 missing values generated)

. replace result = exp(mulogimpres) if dups==1
(52 real changes made)

. by stationid sampledate sampletime parametercode: keep if _n==1
(34 observations deleted)

. 
. * flag only values as non-detect if both samples were non-detect
. replace qualifier = "" if dups==1 & (result <0.09 | result>0.11)
(4 real changes made)

. drop *impres* dups

. 
. 
. duplicates report stationid sampledate sampletime parametercode

Duplicates in terms of stationid sampledate sampletime parametercode

--------------------------------------
   copies | observations       surplus
----------+---------------------------
        1 |         1546             0
--------------------------------------

. 
. 
. *------------------------------------------
. * Create indicator stub names and
. * then reshape the data to wide format
. *------------------------------------------     
. gen ind = "enteroQPCRcce" if parametercode=="Enterococcus faecalis"
(773 missing values generated)

.         replace ind = "bactQPCRcce" if parametercode=="Bacteroides"
(773 real changes made)

.         assert ind!=""

.         
. keep stationid coldate sampletime ind result qualifier

. order stationid coldate sampletime ind result qualifier

. reshape wide result qualifier, i(stationid coldate sampletime) j(ind, string)
(note: j = bactQPCRcce enteroQPCRcce)

Data                               long   ->   wide
-----------------------------------------------------------------------------
Number of obs.                     1546   ->     773
Number of variables                   6   ->       7
j variable (2 values)               ind   ->   (dropped)
xij variables:
                                 result   ->   resultbactQPCRcce resultenteroQPC
> Rcce
                              qualifier   ->   qualifierbactQPCRcce qualifierent
> eroQPCRcce
-----------------------------------------------------------------------------

. 
. 
. *------------------------------------------
. * Flag non-detect values and set them to 0
. * to be consistent with other datasets
. * assume samples with values of 0 are NDs
. *------------------------------------------     
. 
. local vars "enteroQPCRcce bactQPCRcce"

. foreach var of local vars  {
  2.         rename result`var' `var'
  3.         gen `var'_nd = 1 if inlist(qualifier`var',"<","ND") | (`var'==0)
  4.                 replace `var'_nd = 0 if (`var'!=.) & (`var'_nd==.)
  5.                 label values `var'_nd ND
  6.         replace `var' = 0 if `var'_nd==1
  7.                 
.         
. }
(727 missing values generated)
(727 real changes made)
(2 real changes made)
(458 missing values generated)
(458 real changes made)
(1 real change made)

. drop qualifier*

. order stationid coldate sampletime enteroQPCRcce* bactQPCRcce*

. 
. *------------------------------------------
. * Label variables and add notes
. *------------------------------------------     
. 
. gen sampletype = "qPCR sample"

.         label var sampletype "Water sample type"

. 
. 
. rename sampletime coltime

. label var coltime "Sample collection time"

. label var enteroQPCRcce "Enterococcus, qPCR EPA 1611 CCE/100ml"

. label var enteroQPCRcce_nd "Enterococcus, qPCR EPA 1611 below detection"

. label var bactQPCRcce "Bacteroides, qPCR CCE/100ml"

. label var bactQPCRcce_nd "Bacteroides, qPCR below detection"

. 
. sort stationid coldate coltime

. tempfile qpcr

. save `qpcr'
file /var/folders/bp/zslz_kn157v3zs98sv57pflc0000gn/T//S_00741.000002 saved

. 
. 
. *------------------------------------------
. * load the coliphage sample data
. *------------------------------------------
. 
. insheet using "~/dropbox/13beaches/data/untouched/missionbay/wq/tblPhageData.c
> sv", comma clear
(9 vars, 282 obs)

. 
. * extract sample date
. gen coldate = date(substr(sampledate,1,8),"MDY",2020)

.         format coldate %d

.         label var coldate "Sample collection date"

. 
. * code stationid to be consistent with the other data
. gen stationid = ""
(282 missing values generated)

.         replace stationid = "COMP1X" if samplesite=="Visitor's"
variable stationid was str1 now str6
(46 real changes made)

.         replace stationid = "COMP2X" if samplesite=="Tecolote"
(48 real changes made)

.         replace stationid = "COMP3X" if samplesite=="L. Lagoon"
(46 real changes made)

.         replace stationid = "COMP4X" if samplesite=="DeAnza"
(44 real changes made)

.         replace stationid = "COMP5X" if samplesite=="Crown Point"
(50 real changes made)

.         replace stationid = "COMP6X" if samplesite=="Bonita Cove"
(48 real changes made)

.         assert stationid!=""

.         label var stationid "stationid"

. 
. * ensure no duplicate obs
. duplicates report stationid sampledate coliphag

Duplicates in terms of stationid sampledate coliphageenrichment

--------------------------------------
   copies | observations       surplus
----------+---------------------------
        1 |          282             0
--------------------------------------

. 
. 
. *------------------------------------------
. * Create indicator stub names and
. * then reshape the data to wide format
. *------------------------------------------     
. gen ind = "fpc1601mpn" if coliphageenrichment == "male-specific"
(141 missing values generated)

.         replace ind = "fmc1601mpn" if coliphageenrichment == "Somatic"
(141 real changes made)

.         assert ind!=""

.         
. keep stationid coldate ind result qualifier

. order stationid coldate ind result qualifier

. reshape wide result qualifier, i(stationid coldate) j(ind, string)
(note: j = fmc1601mpn fpc1601mpn)

Data                               long   ->   wide
-----------------------------------------------------------------------------
Number of obs.                      282   ->     141
Number of variables                   5   ->       6
j variable (2 values)               ind   ->   (dropped)
xij variables:
                                 result   ->   resultfmc1601mpn resultfpc1601mpn
                              qualifier   ->   qualifierfmc1601mpn qualifierfpc1
> 601mpn
-----------------------------------------------------------------------------

. 
. 
. *------------------------------------------
. * Flag non-detect values and set them to 0
. * to be consistent with other datasets
. *------------------------------------------     
. 
. local vars "fpc1601mpn fmc1601mpn"

. foreach var of local vars  {
  2.         rename result`var' `var'
  3.         gen `var'_nd = 1 if inlist(qualifier`var',"<","ND")
  4.                 replace `var'_nd = 0 if (`var'!=.) & (`var'_nd==.)
  5.                 label values `var'_nd ND
  6.         replace `var' = 0 if `var'_nd==1
  7.                 
.         
. }
(16 missing values generated)
(16 real changes made)
(125 real changes made)
(96 missing values generated)
(96 real changes made)
(45 real changes made)

. drop qualifier*

. order stationid coldate fpc1601mpn* fmc1601mpn*

. 
. *------------------------------------------
. * Label variables and add notes
. *------------------------------------------     
. 
. gen sampletype = "Daily composite sample"

.         label var sampletype "Water sample type"

. 
. label var fpc1601mpn "F+ Coliphage, EPA 1601 MPN/100ml"

. label var fpc1601mpn_nd "F+ Coliphage, EPA 1601 below detection"

. label var fmc1601mpn "F- Coliphage, EPA 1601 MPN/100ml"

. label var fmc1601mpn_nd "F- Coliphage, EPA 1601 below detection"

. 
. sort stationid coldate

. tempfile phage

. save `phage'
file /var/folders/bp/zslz_kn157v3zs98sv57pflc0000gn/T//S_00741.000003 saved

. 
. *------------------------------------------
. * SAMPLE-LEVEL DATASET SYNTHESIS
. *------------------------------------------
. 
. *------------------------------------------
. * Merge the Coliphage data onto the
. * culture data for daily composite samples
. *------------------------------------------     
. use `culture', clear

. keep if sampletype =="Daily composite sample"
(1,944 observations deleted)

. sort stationid coldate

. merge 1:1 stationid coldate using `phage'

    Result                           # of obs.
    -----------------------------------------
    not matched                            21
        from master                        21  (_merge==1)
        from using                          0  (_merge==2)

    matched                               141  (_merge==3)
    -----------------------------------------

.         assert _merge !=2

.         drop _merge

. 
. tempfile comps

. save `comps'
file /var/folders/bp/zslz_kn157v3zs98sv57pflc0000gn/T//S_00741.000004 saved

. 
. 
. *------------------------------------------
. * Merge the qPCR data onto the
. * culture data for hourly samples
. *------------------------------------------     
. use `culture', clear

. drop if sampletype =="Daily composite sample"
(162 observations deleted)

. sort stationid coldate coltime

. merge 1:1 stationid coldate coltime using `qpcr'

    Result                           # of obs.
    -----------------------------------------
    not matched                         1,171
        from master                     1,171  (_merge==1)
        from using                          0  (_merge==2)

    matched                               773  (_merge==3)
    -----------------------------------------

.         assert _merge !=2

.         drop _merge

.         
. * append the composite samples
. append using `comps'
(label ND already defined)

. 
. 
. *------------------------------------------
. * Final variable organization and labeling
. *------------------------------------------     
. 
. 
. * create a beach number for consistency with
. * the epidemiology data
. gen beach = "Mission Bay"

.         label var beach "Beach"

. gen beachcode = "Mission Bay " + substr(stationid,strlen(stationid)-1,1)

.         label var beachcode "Mission Bay Beach Code"

. 
. 
. order sampletype beachcode stationid coldate coltime enteroELTmpn - tcolifcfu_
> nd enteroQPCRcce - bactQPCRcce_nd 

. sort sampletype beachcode stationid coldate coltime

. 
. 
. * add dataset and variable notes
. notes: All non-detect values are set to 0 and flagged with _nd indicators

. notes enteroQPCRcce: only analyzed in 2 samples per day

. notes bactQPCRcce: only analyzed in 2 samples per day

. notes entero1600cfu: only analyzed in daily composite samples

. notes ecoliCLTmpn: only analyzed in daily composite samples

. notes tcolCLTmpn: only analyzed in daily composite samples

. notes fpc1601mpn: only analyzed in daily composite samples

. notes fmc1601mpn: only analyzed in daily composite samples

. 
. *------------------------------------------
. * Save a sample-level dataset
. *------------------------------------------
. 
. compress
  variable coldate was float now int
  variable enteroELTmpn_nd was float now byte
  variable fcolifcfu_nd was float now byte
  variable tcolifcfu_nd was float now byte
  variable enteroQPCRcce_nd was float now byte
  variable bactQPCRcce_nd was float now byte
  variable entero1600cfu was long now int
  variable entero1600cfu_nd was float now byte
  variable ecoliCLTmpn was long now int
  variable ecoliCLTmpn_nd was float now byte
  variable tcolCLTmpn was long now int
  variable tcolCLTmpn_nd was float now byte
  variable fpc1601mpn_nd was float now byte
  variable fmc1601mpn_nd was float now byte
  (80,028 bytes saved)

. label data "Mission Bay water sample data, formatted by 7-format-mb-wq.do"

. save "~/dropbox/13beaches/data/final/mb-wq-samples.dta", replace
file ~/dropbox/13beaches/data/final/mb-wq-samples.dta saved

. outsheet using "~/dropbox/13beaches/data/final/mb-wq-samples.csv", comma repla
> ce

. 
. desc

Contains data from ~/dropbox/13beaches/data/final/mb-wq-samples.dta
  obs:         2,106                          Mission Bay water sample data,
                                                formatted by 7-format-mb-wq.do
 vars:            26                          17 Sep 2015 14:21
 size:       210,600                          (_dta has notes)
--------------------------------------------------------------------------------
              storage   display    value
variable name   type    format     label      variable label
--------------------------------------------------------------------------------
sampletype      str22   %22s                  Water sample type
beachcode       str13   %13s                  Mission Bay Beach Code
stationid       str6    %9s                   Station
coldate         int     %d                    Sample collection date
coltime         int     %8.0g                 Sample collection time
enteroELTmpn    long    %12.0g                Enterococcus, Enterolert MPN/100ml
enteroELTmpn_nd byte    %15.0g     ND         Enterococcus, Enterolert below
                                                detection
fcolifcfu       long    %12.0g                Fecal coliform, APHA 9222D
                                                CFU/100ml
fcolifcfu_nd    byte    %15.0g     ND         Fecal coliform, APHA 9222D below
                                                detection
tcolifcfu       long    %12.0g                Total coliform, APHA 9222B
                                                CFU/100ml
tcolifcfu_nd    byte    %15.0g     ND         Total coliform, APHA 9222B below
                                                detection
enteroQPCRcce   float   %9.0g               * Enterococcus, qPCR EPA 1611
                                                CCE/100ml
enteroQPCRcce~d byte    %9.0g      ND         Enterococcus, qPCR EPA 1611 below
                                                detection
bactQPCRcce     float   %9.0g               * Bacteroides, qPCR CCE/100ml
bactQPCRcce_nd  byte    %9.0g      ND         Bacteroides, qPCR below detection
entero1600cfu   int     %12.0g              * Enterococcus, EPA 1600 CFU/100ml
entero1600cfu~d byte    %15.0g     ND         
ecoliCLTmpn     int     %12.0g              * E. coli, Colilert below detection
ecoliCLTmpn_nd  byte    %15.0g     ND         
tcolCLTmpn      int     %12.0g              * Total coliform, Colilert MPN/100ml
tcolCLTmpn_nd   byte    %15.0g     ND         Total coliform, Colilert below
                                                detection
fpc1601mpn      float   %9.0g               * F+ Coliphage, EPA 1601 MPN/100ml
fpc1601mpn_nd   byte    %9.0g      ND         F+ Coliphage, EPA 1601 below
                                                detection
fmc1601mpn      float   %9.0g               * F- Coliphage, EPA 1601 MPN/100ml
fmc1601mpn_nd   byte    %9.0g      ND         F- Coliphage, EPA 1601 below
                                                detection
beach           str11   %11s                  Beach
                                            * indicated variables have notes
--------------------------------------------------------------------------------
Sorted by: sampletype  beachcode  stationid  coldate  coltime

. codebook, c

Variable       Obs Unique      Mean    Min       Max  Label
--------------------------------------------------------------------------------
sampletype    2106      2         .      .         .  Water sample type
beachcode     2106      6         .      .         .  Mission Bay Beach Code
stationid     2106     24         .      .         .  Station
coldate       2106     27  15906.52  15856     15949  Sample collection date
coltime       2104    235  1377.187   1202      1713  Sample collection time
enteroELTmpn  1944    142  108.3632      0     57940  Enterococcus, Enteroler...
enteroELTm~d  1944      2  .3225309      0         1  Enterococcus, Enteroler...
fcolifcfu     1944     86  176.2274      0     48000  Fecal coliform, APHA 92...
fcolifcfu_nd  1944      2  .1779835      0         1  Fecal coliform, APHA 92...
tcolifcfu     1944     85   289.751      0     45000  Total coliform, APHA 92...
tcolifcfu_nd  1944      2  .4408436      0         1  Total coliform, APHA 92...
enteroQPCR~e   773    529  619.9955      0  141092.8  Enterococcus, qPCR EPA ...
enteroQPCR~d   773      2  .0595084      0         1  Enterococcus, qPCR EPA ...
bactQPCRcce    773    416  19717.03      0   3718815  Bacteroides, qPCR CCE/1...
bactQPCRcc~d   773      2  .4075032      0         1  Bacteroides, qPCR below...
entero1600~u   162     40  83.67901      0      3100  Enterococcus, EPA 1600 ...
entero1600~d   162      2  .1851852      0         1  
ecoliCLTmpn    162     96  314.0309      0      5172  E. coli, Colilert below...
ecoliCLTmp~d   162      2  .0679012      0         1  
tcolCLTmpn     162    122  2833.994      0     24192  Total coliform, Coliler...
tcolCLTmpn~d   162      2  .0246914      0         1  Total coliform, Coliler...
fpc1601mpn     141      6  .0295745      0       .77  F+ Coliphage, EPA 1601 ...
fpc1601mpn~d   141      2  .8865248      0         1  F+ Coliphage, EPA 1601 ...
fmc1601mpn     141     17  1.290496      0     36.63  F- Coliphage, EPA 1601 ...
fmc1601mpn~d   141      2  .3191489      0         1  F- Coliphage, EPA 1601 ...
beach         2106      1         .      .         .  Beach
--------------------------------------------------------------------------------

. 
. 
. *------------------------------------------
. * CALCULATE DAILY AVERAGES
. *------------------------------------------
. 
. *----------------------------------------
. * calculate mean log10 values by day/beach
. *----------------------------------------
. use "~/dropbox/13beaches/data/final/mb-wq-samples.dta", clear
(Mission Bay water sample data, formatted by 7-format-mb-wq.do)

. 
. 
. * impute non-detects as 0.1 (consistent w/ other datasets)
. local vlist "entero1600cfu enteroQPCRcce enteroELTmpn fpc1601mpn fmc1601mpn"

. foreach var of local vlist {
  2.         di as res _n "Imputing NDs for `var'"
  3.         replace `var' = 0.1 if `var'_nd==1
  4. }

Imputing NDs for entero1600cfu
variable entero1600cfu was int now float
(30 real changes made)

Imputing NDs for enteroQPCRcce
(46 real changes made)

Imputing NDs for enteroELTmpn
variable enteroELTmpn was long now double
(627 real changes made)

Imputing NDs for fpc1601mpn
(125 real changes made)

Imputing NDs for fmc1601mpn
(45 real changes made)

. 
. * calculate log10 values for each indicator
. gen logentero1600 = log10(entero1600cfu)
(1,944 missing values generated)

.         label var logentero1600 "log10 Entero EPA 1600"

. gen logenteropcr = log10(enteroQPCRcce)
(1,333 missing values generated)

.         label var logenteropcr "log10 Entero qPCR EPA 1611"

. gen logenteroELT = log10(enteroELTmpn)
(162 missing values generated)

.         label var logenteroELT "log10 Entero Enterolert"

. gen logfpc1601 = log10(fpc1601mpn)
(1,965 missing values generated)

.         label var logfpc1601 "log10 F+ Coliphage EPA 1601"

. gen logfmc1601 = log10(fmc1601mpn)
(1,965 missing values generated)

.         label var logfmc1601 "log10 F- Coliphage EPA 1601"

.         
. * calculate daily average log10 values
. local stubs "entero1600 enteropcr enteroELT fpc1601 fmc1601"

. foreach stub of local stubs {
  2.         sort beach beachcode coldate
  3.         by beach beachcode coldate: egen _dy = mean(log`stub')
  4.         by beach beachcode coldate: egen avgdy`stub' = max(_dy)
  5.         drop _dy
  6.         local stublab : var label log`stub'
  7.         label var avgdy`stub' "Daily Avg `stublab'"
  8. }
(390 missing values generated)
(390 missing values generated)
(269 missing values generated)
(269 missing values generated)
(269 missing values generated)
(269 missing values generated)

. 
. * keep 1 obs per beach and day, and subset to relevant variables
. bysort beach beachcode coldate: keep if _n==1
(1,944 observations deleted)

. 
. * drop 3 days (may 24, 25, 26) with completely empty data
. drop if coldate < mdy(5,27,2003)
(0 observations deleted)

. 
. keep beach beachcode coldate avgdy*

. 
. gen marine = 1

.         label var marine "Marine beach"

. order beach beachcode marine coldate 

. 
. *----------------------------------------
. *  save a daily log10 average dataset
. *----------------------------------------
. 
. compress
  variable marine was float now byte
  (486 bytes saved)

. label data "Mission Bay beach-level water quality data, created by 7-format-mb
> -wq.do"

. save "~/dropbox/13beaches/data/final/mb-wq.dta", replace
file ~/dropbox/13beaches/data/final/mb-wq.dta saved

. outsheet using "~/dropbox/13beaches/data/final/mb-wq.csv", comma replace

. 
. desc

Contains data from ~/dropbox/13beaches/data/final/mb-wq.dta
  obs:           162                          Mission Bay beach-level water
                                                quality data, created by
                                                7-format-mb-wq.do
 vars:             9                          17 Sep 2015 14:21
 size:         7,614                          (_dta has notes)
--------------------------------------------------------------------------------
              storage   display    value
variable name   type    format     label      variable label
--------------------------------------------------------------------------------
beach           str11   %11s                  Beach
beachcode       str13   %13s                  Mission Bay Beach Code
marine          byte    %9.0g                 Marine beach
coldate         int     %d                    Sample collection date
avgdyentero1600 float   %9.0g                 Daily Avg log10 Entero EPA 1600
avgdyenteropcr  float   %9.0g                 Daily Avg log10 Entero qPCR EPA
                                                1611
avgdyenteroELT  float   %9.0g                 Daily Avg log10 Entero Enterolert
avgdyfpc1601    float   %9.0g                 Daily Avg log10 F+ Coliphage EPA
                                                1601
avgdyfmc1601    float   %9.0g                 Daily Avg log10 F- Coliphage EPA
                                                1601
--------------------------------------------------------------------------------
Sorted by: beach  beachcode  coldate

. 
. log close
      name:  <unnamed>
       log:  /Users/benarnold/dropbox/13beaches/src/dm/7-format-mb-wq.log
  log type:  text
 closed on:  17 Sep 2015, 14:21:30
--------------------------------------------------------------------------------
