---------------------------------------------------------------------------------------
      name:  <unnamed>
       log:  /Users/jadederong/dropbox/13beaches/src/dm/7-format-mb-wq-jbc.log
  log type:  text
 opened on:  16 Jul 2015, 14:05:27

. 
. *----------------------------------------
. * 7-format-mb-wq.do
. * ben arnold
. *
. * format the Mission Bay water quality data
. * water quality data.
. * 
. * calculate log averages using a standardized
. * imputation approach for values at 
. * the detection limits
. * for values below LOD, use LOD/2
. * for values at upper LOD, use upper LOD
. *
. * version 3 (15 jul 2015) by Jade
. * modify script to output a dataset with 
. * a row for each sample
. *
. * version 2 (21 feb 2015)
. * updated the beach code
. *
. * version 1 (3 feb 2015)
. *
. *----------------------------------------
. 
. *----------------------------------------
. * input files:
. *       mb_analysis_final.dta
. *
. * output files:
. *       mb-wq.dta
. *
. *----------------------------------------
. 
. 
. *----------------------------------------
. * read in the Mission Bay analysis dataset
. * and subset it to the water quality
. * indicators 
. *----------------------------------------
. use "~/dropbox/13beaches/data/untouched/missionbay/mb_analysis_final.dta", clear
(SD WET Microbiolgoical Data)

. 
. *----------------------------------------
. * Create dataset with one row for each sample
. * Subset to final variables and save data
. *----------------------------------------
. 
. *----------------------------------------
. * subset to the water quality indicators
. * of interest, and reduce the data to
. * 1 obs per day of sampling for each beach
. *----------------------------------------
. 
. * note: for the enterococcus measurements, its unclear what samples 1-4 indicate
. * so, we are carrying forward with the daily geometric mean for the entire beach
. 
. keep sdate station g_mean_beach_entero g_mean_beach_entero_pcr result_phage_m qualifi
> er_phage_m result_phage_s qualifier_phage_s 

. 
. gen beachcode = "Mission Bay " + substr(station,1,1)

.         label var beachcode "Mission bay beach code"

.         drop station

.         
. bysort sdate beachcode: keep if _n==1
(12,292 observations deleted)

. order sdate beachcode

. rename sdate coldate

. label var coldate "Sample collection date"

. 
. gen beach = "Mission Bay"

.         label var beach "Study Beach"

.         
. gen marine = 1

.         label var marine "Marine Beach"

.         
. ren result_phage_m fpc1601 

. ren result_phage_s fmc1601

. ren qualifier_phage_m qualfpc1601

. ren qualifier_phage_s qualfmc1601

. 
. order beach coldate beachcode marine

. 
. * drop averaged variables
. drop g_mean*

. 
. * drop days/beach sites with no water quality information
. drop if (fpc1601==.) & (fmc1601==.)
(38 observations deleted)

. 
. * convert from wide to long format
. foreach var of varlist fpc1601 fmc1601{
  2.         ren `var' result`var'
  3. }

. 
. reshape long result qual, i(beach coldate beachcode) j(groupindex) string
(note: j = fmc1601 fpc1601)

Data                               wide   ->   long
-----------------------------------------------------------------------------
Number of obs.                      139   ->     278
Number of variables                   8   ->       7
j variable (2 values)                     ->   groupindex
xij variables:
            resultfmc1601 resultfpc1601   ->   result
                qualfmc1601 qualfpc1601   ->   qual
-----------------------------------------------------------------------------

. 
. drop if result==.
(0 observations deleted)

. 
. * generate variables to match other datasets
. gen indicator=""
(278 missing values generated)

. replace indicator="Fminus coliphage" if groupindex=="fmc1601"
variable indicator was str1 now str16
(139 real changes made)

. replace indicator="Fplus coliphage" if groupindex=="fpc1601"
(139 real changes made)

. 
. gen analysismethod=""
(278 missing values generated)

. replace analysismethod="EPA 1601" if groupindex=="fmc1601" | groupindex=="fpc1601"
variable analysismethod was str1 now str8
(278 real changes made)

. 
. gen log10 = log10(result)

.         
. drop groupindex

. 
. compress
  variable coldate was float now int
  variable marine was float now byte
  (1,390 bytes saved)

. label data "Mission Bay beach-level water quality sample data, created by 7-format-mb
> -wq-sample.do"
note: label truncated to 80 characters

. save "~/dropbox/13beaches/data/final/mb-wq-samples.dta", replace
file ~/dropbox/13beaches/data/final/mb-wq-samples.dta saved

. 
. desc

Contains data from ~/dropbox/13beaches/data/final/mb-wq-samples.dta
  obs:           278                          Mission Bay beach-level water quality
                                                sample data, created by
                                                7-format-mb-wq-sam
 vars:             9                          16 Jul 2015 14:05
 size:        16,680                          
---------------------------------------------------------------------------------------
              storage   display    value
variable name   type    format     label      variable label
---------------------------------------------------------------------------------------
beach           str11   %11s                  Study Beach
coldate         int     %td                   Sample collection date
beachcode       str13   %13s                  Mission bay beach code
marine          byte    %9.0g                 Marine Beach
result          float   %9.0g                 
qual            str1    %9s                   
indicator       str16   %16s                  
analysismethod  str8    %9s                   
log10           float   %9.0g                 
---------------------------------------------------------------------------------------
Sorted by: beach  coldate  beachcode

. 
. *----------------------------------------
. * subset to the water quality indicators
. * of interest, and reduce the data to
. * 1 obs per day of sampling for each beach
. *----------------------------------------
. use "~/dropbox/13beaches/data/untouched/missionbay/mb_analysis_final.dta", clear
(SD WET Microbiolgoical Data)

. 
. * note: for the enterococcus measurements, its unclear what samples 1-4 indicate
. * so, we are carrying forward with the daily geometric mean for the entire beach
. 
. keep sdate station g_mean_beach_entero g_mean_beach_entero_pcr result_phage_m qualifi
> er_phage_m result_phage_s qualifier_phage_s 

. 
. gen beachcode = "Mission Bay " + substr(station,1,1)

.         label var beachcode "Mission bay beach code"

.         drop station

.         
. bysort sdate beachcode: keep if _n==1
(12,292 observations deleted)

. order sdate beachcode

. 
. 
. 
. *----------------------------------------
. * Enterococcus EPA 1600 and QPCR
. *----------------------------------------
. gen avgdyentero1600 = log10(g_mean_beach_entero)
(21 missing values generated)

.         label var avgdyentero1600 "Daily Avg log10 Entero EPA 1600"

. 
. gen avgdyenteropcr = log10(g_mean_beach_entero_pcr)
(46 missing values generated)

.         label var avgdyenteropcr "Daily Avg log10 Entero EPA qPCR"

. 
. 
. *----------------------------------------
. * Coliphage EPA 1601
. *----------------------------------------
. * recode the phage results as 0.1 for non-detects (consistent with NEEAR)
. replace result_phage_m = 0.1 if qualifier_phage_m=="<"
(0 real changes made)

. replace result_phage_s = 0.1 if qualifier_phage_s=="<"
(0 real changes made)

. 
. gen avgdyfpc1601 = log10(result_phage_m)
(38 missing values generated)

.         label var avgdyfpc1601 "Daily Avg log10 F-plus Coliphage EPA 1601"

. gen avgdyfmc1601 = log10(result_phage_s)
(38 missing values generated)

.         label var avgdyfmc1601 "Daily Avg log10 F-minus Coliphage EPA 1601"

. 
. 
. *----------------------------------------
. * Subset to final variables and save data
. *----------------------------------------
. rename sdate coldate

. label var coldate "Sample collection date"

. 
. gen beach = "Mission Bay"

.         label var beach "Study Beach"

.         
. gen marine = 1

.         label var marine "Marine Beach"

. 
. keep beach coldate beachcode marine avgdy*

. order beach coldate beachcode marine

. 
. * drop days/beach sites with no water quality information
. drop if (avgdyentero1600==.) & (avgdyenteropcr==.) & (avgdyfpc1601==.) & (avgdyfmc160
> 1==.)
(20 observations deleted)

. 
. 
. 
. compress
  variable coldate was float now int
  variable marine was float now byte
  (785 bytes saved)

. label data "Mission Bay beach-level water quality data, created by 7-format-mb-wq.do"

. save "~/dropbox/13beaches/data/final/mb-wq.dta", replace
file ~/dropbox/13beaches/data/final/mb-wq.dta saved

. 
. desc

Contains data from ~/dropbox/13beaches/data/final/mb-wq.dta
  obs:           157                          Mission Bay beach-level water quality
                                                data, created by 7-format-mb-wq.do
 vars:             8                          16 Jul 2015 14:05
 size:         6,751                          
---------------------------------------------------------------------------------------
              storage   display    value
variable name   type    format     label      variable label
---------------------------------------------------------------------------------------
beach           str11   %11s                  Study Beach
coldate         int     %td                   Sample collection date
beachcode       str13   %13s                  Mission bay beach code
marine          byte    %9.0g                 Marine Beach
avgdyentero1600 float   %9.0g                 Daily Avg log10 Entero EPA 1600
avgdyenteropcr  float   %9.0g                 Daily Avg log10 Entero EPA qPCR
avgdyfpc1601    float   %9.0g                 Daily Avg log10 F-plus Coliphage EPA 1601
avgdyfmc1601    float   %9.0g                 Daily Avg log10 F-minus Coliphage EPA
                                                1601
---------------------------------------------------------------------------------------
Sorted by: coldate  beachcode

. 
. log close
      name:  <unnamed>
       log:  /Users/jadederong/dropbox/13beaches/src/dm/7-format-mb-wq-jbc.log
  log type:  text
 closed on:  16 Jul 2015, 14:05:27
---------------------------------------------------------------------------------------
